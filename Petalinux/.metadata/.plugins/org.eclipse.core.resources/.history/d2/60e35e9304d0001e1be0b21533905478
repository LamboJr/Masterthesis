#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <stdbool.h>
#include <arpa/inet.h>
#include <assert.h>

#include "../Includes/DataTypes.h"

#include "../Includes/TestDataTrade.h"
#include "../Includes/TradeHandler.h"

#include "../Includes/decode_Pokemon_structure.h"
#include "../TCP_Server.h"

#include "../Includes/Ringbuffer.h"


#define MODE_TRADE 0
#define MODE_MONITOR 1

#define TESTDATA_ARRAY TestDataTradePokemonExchange

extern FILE *PokemonFp;

extern u16 Magikarp_pokemonbuffer[50];

void StartFunctionTestPrint(char *FuncName){
	printf("Start test of function --%s--\n",FuncName);
	return;
}
void EndFunctionTestPrint(char *FuncName){
	printf("Test of function --%s-- successful\n",FuncName);
	return;
}

void main_TradeHandlerTest()
{
	printf("Test for Tradehandler\n");

	u32 OPMode = MODE_TRADE;

	printf("Set Mode to Trading Mode\n");
	//Configure Trading or Monitoring mode

	FILE *fp;
	printf("Write Monitor Output to file log.txt\n");
	// Open file in write mode
	fp = fopen("/home/petalinux/log.txt", "w");
	 // Check if file opened successfully
	if (fp == NULL) {
		printf("Error opening file.\n");
		return;
	}
	// Write output to file
	//fprintf(fp, "This is the output that will be written to the file.\n");
	printf("Write Extracted Data into datalog.txt\n");
	PokemonFp = fopen("/home/petalinux/datalog.txt","w");
	if(PokemonFp == NULL){
		printf("Error opening file datalog.txt.\n");
		return;
	}


	printf("Staring Test Tradehanlder Program\n");

	u16 data;
	u16 returnvalue = 0;
	for(int i = 0; i < sizeof(TESTDATA_ARRAY);i++){
		data = (u16)((TESTDATA_ARRAY[i] >> 16) & 0xFFFF);
		returnvalue = TradeHandler(data,0x0);
	}
	extern u16 ReceivedTeam[6][50];
	for(int u = 0;u <6;u++){
		decode_Pokemon_data(ReceivedTeam[u]);
	}

	return;
}


void ButtonPressTest(){
	printf("Test of function --DetectButtonPress--\n");

	char *Buttontype = "Reset";
	u8 ButtonState = 0;
	assert(DetectButtonPress(ButtonState, Buttontype) == 0);
	ButtonState = 1;
	assert(DetectButtonPress(ButtonState, Buttontype) == 1);
	assert(DetectButtonPress(ButtonState, Buttontype) == 0);
	assert(DetectButtonPress(ButtonState, Buttontype) == 0);
	ButtonState = 0;
	assert(DetectButtonPress(ButtonState, Buttontype) == 0);
	assert(DetectButtonPress(ButtonState, Buttontype) == 0);
	ButtonState = 1;
	assert(DetectButtonPress(ButtonState, Buttontype) == 1);
	printf("Test of function --DetectButtonPress-- successful\n");
	return;
}

void  UpdateFramecounterTest(){
	printf("Test of function --UpdataFrameCounter--\n");
	u32 FrameCounter = 1;
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 2);
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 3);
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 4);
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 5);
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 6);
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 7);
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 8);
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 9);
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 1);
	UpdateFrameCounter(&FrameCounter);	assert(FrameCounter == 2);

	printf("Test of function --UpdateFrameCounter-- succesful\n");
	return;
}

void GenerateBlockInitArrayTestold(){
	printf("Test of function --GenerateBlockInitArray--\n");

	u16 Blocksize = 0xC8;
	u16 BlockInitArray[8] = {0,0,0,0,0,0,0,0};
	size_t Arraysize = sizeof(BlockInitArray)/sizeof(u16);
	//printf("Number of Array elements : %d\n",Arraysize);
	GenerateBlockInitArray(Blocksize, BlockInitArray);

	assert(BlockInitArray[0] == 0xBBBB);
	assert(BlockInitArray[1] == Blocksize);
	assert(BlockInitArray[2] == 0x0081);
	for(int i = 3; i < Arraysize;i++ ){
		assert(BlockInitArray[i] == 0x0);
		//printf("BlockInitArray[%d] = %04x\n",i,BlockInitArray[i]);
	}
	printf("Test of function --GenerateBlockInitArray-- successful\n");
	return;
}

void GenerateBlockInitTest(){

	StartFunctionTestPrint("GenerateBlockInit");
	extern struct BufferType s_DataBuffer;
	extern struct BufferType s_ControlBuffer;
	ResetBuffer(&s_ControlBuffer);
	ResetBuffer(&s_DataBuffer);
	u16 Blocksize = 0xC8;
	u16 BlockInitArray[8] = {0xBBBB,Blocksize,0x0081,0,0,0,0,0};
	GenerateBlockInit(Blocksize);
	assert(ReadBuffer(&s_ControlBuffer) == BlockInitArray[0]);
	for(int i = 1;i < FRAME_LENGTH-1;i++){
		assert(ReadBuffer(&s_DataBuffer) == BlockInitArray[i]);
	}
	EndFunctionTestPrint("GenerateBlockInit");
	return;
}


void GenerateDataBlockArrayTest(){
	printf("Test of function --GenerateDataBlockArray--\n");
	u16 Blocksize = 0xC8;
	u16 DATABLOCKARRAYSIZE = 200;
	u16 DataBlockArray[DATABLOCKARRAYSIZE];
	u16 Databuffer[100];

	for(int i = 0; i < 100;i++){
		DataBlockArray[i] = 0;
	}
	for(int i = 0; i < 100;i++){
		if (i <50){
			Databuffer[i] = Magikarp_pokemonbuffer[i];
		}else{
			Databuffer[i] = Magikarp_pokemonbuffer[i-50];
		}
	}

	GenerateDataBlockArray(Blocksize, Databuffer, DataBlockArray);

	for (int i = 0; i < DATABLOCKARRAYSIZE;i++){

	}

	//assert(DataBlockArray[i] == Databuffer[u]);


	printf("Test of function --GenerateDataBlockArray-- successful\n");
	return;
}


void ReadyToTradeTest(){
	printf("Test of function --ReadyToTrade--\n");
	u32 FrameCounter = 1;
	u32 data =0;
	u16 returnvalue = 0;
	u8 SpotNumber = 1;
	s8 Check = 0;
	Check = ReadytoTrade(FrameCounter,data,&returnvalue,SpotNumber);



	printf("Test of function --ReadyToTrade-- successful\n");
	return;
}


void ReadBufferTest(){
	StartFunctionTestPrint("ReadBuffer");
	u16 returnvalue;
	struct BufferType s_Testbuffer;
	for(int i = 0;i <20 ;i++){
		s_Testbuffer.Data[i] = i+10;
	}
	ResetBuffer(&s_Testbuffer);

	returnvalue = ReadBuffer(&s_Testbuffer);
	assert(returnvalue == 0);
	s_Testbuffer.WriteIndex = 10;

	for(int i = 0; i<10;i++){
		assert((s_Testbuffer.ReadIndex == i) && (ReadBuffer(&s_Testbuffer) == (i+10)) && (s_Testbuffer.ReadIndex == i+1));
	}
	//WRiteindex should equal RedaIndex
	assert((ReadBuffer(&s_Testbuffer) == 0) && (s_Testbuffer.ReadIndex == 10));
	assert((ReadBuffer(&s_Testbuffer) == 0) && (s_Testbuffer.ReadIndex == 10));

	//Test wrap around the buffer
	s_Testbuffer.ReadIndex = MAX_BUFFER_LENGTH-1;
	s_Testbuffer.WriteIndex = 0;
	returnvalue = ReadBuffer(&s_Testbuffer);
	assert((s_Testbuffer.ReadIndex == 0));

	EndFunctionTestPrint("ReadBuffer");
	return;
}

void WriteBufferTest(){
	StartFunctionTestPrint("WriteBuffer");
	struct BufferType s_Testbuffer;
	ResetBuffer(&s_Testbuffer);
	for(int i = 0;i< 20;i++){

		assert((s_Testbuffer.WriteIndex == i) && (WriteBuffer(i, &s_Testbuffer) == 0) && (s_Testbuffer.WriteIndex == i+1));
	}
	s_Testbuffer.WriteIndex = MAX_BUFFER_LENGTH-1;
	s_Testbuffer.ReadIndex = 1;
	assert((s_Testbuffer.WriteIndex == (MAX_BUFFER_LENGTH-1)) && (WriteBuffer(100, &s_Testbuffer) == 0) && (s_Testbuffer.WriteIndex == 0));
	assert((s_Testbuffer.WriteIndex == 0) && (WriteBuffer(200, &s_Testbuffer) == 1) && (s_Testbuffer.WriteIndex == 1));
	EndFunctionTestPrint("WriteBuffer");
	return;
}

void ResetBufferTest(){
	StartFunctionTestPrint("ResetBuffer");
	extern struct BufferType s_DataBuffer;
	extern struct BufferType s_ControlBuffer;
	ResetBuffer(&s_ControlBuffer);
	ResetBuffer(&s_DataBuffer);
	assert((s_ControlBuffer.WriteIndex == 0) && (s_ControlBuffer.ReadIndex == 0));
	assert((s_DataBuffer.WriteIndex == 0) && (s_DataBuffer.ReadIndex == 0));
	EndFunctionTestPrint("ResetBuffer");
	return;
}

void BufferTest(){
	StartFunctionTestPrint("BufferTest");
	struct BufferType s_TestBuffer;
	ResetBuffer(&s_TestBuffer);
	for (int i = 0;i < 100;i++){
		assert(  (WriteBuffer(i, &s_TestBuffer) == 0) && (ReadBuffer(&s_TestBuffer) == i) && (s_TestBuffer.ReadIndex == s_TestBuffer.WriteIndex));
	}
	EndFunctionTestPrint("BufferTest");
	return;
}




void RunRingbufferTests(){
	ResetBufferTest();
	ReadBufferTest();
	WriteBufferTest();
	BufferTest();
	return;
}
void RunAllTests(){

	GenerateBlockInitTest();

	UpdateFramecounterTest();

	ButtonPressTest();

	GenerateDataBlockArrayTest();

	RunRingbufferTests();

	main_TradeHandlerTest();
	return;
}
